<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Muse S Bandpower Viewer</title>
    <script src="https://unpkg.com/muse-js@0.8.0/dist/muse.js" type="module"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        pre { background: #f0f0f0; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
<h1>Muse S Bandpower Viewer</h1>
<button id="connect">Connect to Muse S</button>
<pre id="output">Click "Connect to Muse S" to begin.</pre>

<script type="module">
    import { MuseClient, fft } from "https://unpkg.com/muse-js@0.8.0/dist/muse.js";

    const client = new MuseClient();
    const output = document.getElementById('output');
    const SAMPLE_RATE = 256;

    let buffer = {
        TP9: [], AF7: [], AF8: [], TP10: []
    };

    async function start() {
        await client.connect();
        await client.start();

        output.textContent = "Connected to Muse S. Gathering EEG data...";

        client.eegReadings.subscribe(reading => {
            const channel = reading.electrode;
            if (!buffer[channel]) buffer[channel] = [];

            buffer[channel].push(...reading.samples);  // flatten correctly

            if (buffer[channel].length > SAMPLE_RATE) {
                buffer[channel] = buffer[channel].slice(-SAMPLE_RATE);
            }
        });

        setInterval(() => {
            let outputText = 'Frequency-Weighted Bandpower (μV²/Hz):\n';
            const channelNames = ['TP9', 'AF7', 'AF8', 'TP10'];

            for (let ch of channelNames) {
                const samples = buffer[ch];
                if (samples.length < SAMPLE_RATE) continue;

                const fftResult = fft(samples);
                const freqs = fftResult.slice(0, fftResult.length / 2);

                const power = freqs.map(x => x * x);
                const freqsHz = power.length;

                const bandPower = {
                    delta: bandPowerInRange(power, 0.5, 4, freqsHz),
                    theta: bandPowerInRange(power, 4, 8, freqsHz),
                    alpha: bandPowerInRange(power, 8, 13, freqsHz),
                    beta:  bandPowerInRange(power, 13, 30, freqsHz),
                    gamma: bandPowerInRange(power, 30, 45, freqsHz)
                };

                outputText += `${ch}:\n`;
                for (let band in bandPower) {
                    outputText += `  ${band}: ${bandPower[band].toFixed(2)}\n`;
                }
            }

            output.textContent = outputText;
        }, 1000);
    }

    function bandPowerInRange(powerArray, fLow, fHigh, bins) {
        const binSize = SAMPLE_RATE / bins;
        const iLow = Math.floor(fLow / binSize);
        const iHigh = Math.floor(fHigh / binSize);
        let totalPower = 0;
        let weightedSum = 0;
        for (let i = iLow; i <= iHigh; i++) {
            const freq = i * binSize;
            const pwr = powerArray[i] || 0;
            totalPower += pwr;
            weightedSum += freq * pwr;
        }
        return totalPower > 0 ? weightedSum / totalPower : 0;
    }

    document.getElementById('connect').onclick = () => {
        start().catch(e => {
            console.error(e);
            output.textContent = 'Connection failed: ' + e;
        });
    };
</script>
</body>
</html>